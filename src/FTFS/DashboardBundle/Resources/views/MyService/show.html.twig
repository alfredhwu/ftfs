{% extends "FTFSDashboardBundle::layout.html.twig" %}

{% block body_content %}
    {% if is_granted('ROLE_AGENT') %}
        {% include 'FTFSDashboardBundle:MyService:show_content_agent.html.twig' with {
            'read_only' : entity.assignedTo is null or entity.assignedTo != app.user or entity.status not in ['interrupted', 'assigned', 'opened'],
        } %}
    {% elseif is_granted('ROLE_CLIENT') %}
        {% include 'FTFSDashboardBundle:MyService:show_content_client.html.twig' with { 
            'read_only' : entity.requestedBy != app.user or entity.status == 'closed', 
        } %}
    {% endif %}
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script>
    $(document).ready(function () {
        // loading share list to 'div#devices-add-ajax'
        $('a.device-modification').click(function(e) {
            e.preventDefault();
            modify_device($(this));    
        });
        function modify_device(trigger) {
            var device_id = trigger.attr('device-id');
            var href = "{{ path(prefix~'_devices_edit', {'device_id' : '_device_id' }) }}";
            $.ajax({
                type:   "GET",
                url:    href.replace(/_device_id/, device_id),
                data:   "",
                cache:  false,
                success: function(data) {
                    trigger.parent().parent().html(data);
                },
            });
        }
        $.ajax({
            type:   "GET",
            url:    "{{ path(prefix~'_devices_add', {'id' : entity.id }) }}",
            data:   "",
            cache:  false,
            success: function(data) {
                $('div#devices-add-ajax').html(data);
                },
            error:   function() {
                alert("Ooups ... something's got wrong: the ajax connection failed in rendering attachment devices-add-form:(");
                },
        });
        // loading share list to 'div#share-list-add-ajax'
        $.ajax({
            type:   "GET",
            url:    "{{ path(prefix~'_sharelist_add', {'id' : entity.id }) }}",
            data:   "",
            cache:  false,
            success: function(data) {
                $('div#sharelist-add-ajax').html(data);
                },
            error:   function() {
                alert("Ooups ... something's got wrong: the ajax connection failed in rendering attachment sharelist-add-form:(");
                },
        });
        // loading file attachment to 'div#attachment-upload-ajax'
        $.ajax({
            type:   "GET",
            url:    "{{ path(prefix~'_attachment_upload', {'id' : entity.id }) }}",
            data:   "",
            cache:  false,
            success: function(data) {
                $('div#attachment-upload-ajax').html(data);
                },
            error:   function() {
                alert("Ooups ... something's got wrong: the ajax connection failed in rendering attachment upload-form:(");
                },
        });
        // observation add
        $('a.observation-add').click(function() {
            var add_to_id = $(this).attr('add-to-id');
            // loading observation form to 'div#observation-add-ajax'
            $.ajax({
                type:   "GET",
                url:    "{{ path(prefix~'_observation_add', {'id' : entity.id }) }}",
                data:   "add-to-id="+add_to_id,
                cache:  false,
                success: function(data) {
                    $('#observation-add-target').hide();
                    $('div#observation-add-ajax').html(data);
                    $('#observation-add-target').show();
                    },
                error:   function() {
                    alert("Ooups ... something's got wrong: the ajax connection failed in rendering observation add-form:(");
                    },
            });
        });
    });
    </script>
{% endblock %}
